<!-- Header -->
<header id="header">
    <nav class="navbar container">
        <a href="#" class="logo">First Love PDF</a>
        <ul class="nav-menu">
            <li><a href="#hero" class="nav-link">Home</a></li>
            <li><a href="#all-tools" class="nav-link">All Tools</a></li>
            <li><a href="#about-us" class="nav-link">About Us</a></li>
            <li><a href="#contact" class="nav-link">Contact Us</a></li>
        </ul>
        <div class="hamburger">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
    </nav>
</header>

<main>
    <!-- Hero Section -->
    <section id="hero" class="hero">
        <h1 class="reveal">Every tool you need to work with PDFs in one place.</h1>
        <p class="reveal">Completely free, secure, and easy to use. Manage your PDF files directly in your browser without uploading anything.</p>
    </section>

    <!-- Advertisement Placeholder -->
    <div class="ad-placeholder ad-banner-top reveal">
        Advertisement (728x90)
    </div>

    <!-- All Tools Section -->
    <section id="all-tools" class="container">
        <h2 class="section-title reveal">All PDF Tools</h2>
        <div class="tools-grid" id="tools-grid">
            <!-- Tool cards will be generated by JavaScript -->
        </div>
    </section>

    <!-- Article Section (About Us) -->
    <article id="about-us">
        <div class="container reveal">
            <h2>About First Love PDF</h2>
            <p>Welcome to First Love PDF, your all-in-one solution for PDF management. Our mission is to provide simple, powerful, and accessible tools that anyone can use, free of charge. We believe in privacy and security, which is why all processing happens directly in your browser—your files never leave your computer.</p>
            
            <h3>Why PDF Tools Are Essential</h3>
            <p>The Portable Document Format (PDF) is the global standard for sharing documents reliably. However, working with PDFs can be challenging without the right software. Our suite of 27 tools empowers you to handle any PDF task with ease, from simple merges to complex edits.</p>
            
            <h3>Our Core Tools</h3>
            <ul>
                <li><strong>Merge & Split:</strong> Combine multiple PDFs into a single file or extract specific pages to create new documents.</li>
                <li><strong>Compress:</strong> Reduce the file size of your PDFs for easier sharing and storage without compromising quality.</li>
                <li><strong>Convert:</strong> Transform PDFs to and from various formats like Word, PowerPoint, Excel, and JPG.</li>
                <li><strong>Edit & Sign:</strong> Add text, shapes, or drawings directly to your PDF. Create and add your electronic signature in seconds.</li>
                <li><strong>Security:</strong> Protect your documents by adding a password, or remove restrictions with our Unlock PDF tool.</li>
            </ul>
        </div>
    </article>
</main>

<!-- Modal for Tools -->
<div id="toolModal" class="modal">
    <div class="modal-content">
        <div class="modal-main">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">Tool Title</h2>
            
            <div id="tool-interface">
                <div id="drop-area">
                    <input type="file" id="file-input" multiple>
                    <p>Drag & drop files here, or <strong>click to select</strong></p>
                </div>

                <div id="file-list"></div>

                <div id="tool-options"></div>

                <div id="edit-area">
                    <div id="edit-controls">
                        <button id="add-text-btn">Add Text</button>
                        <button id="add-rect-btn">Add Rectangle</button>
                        <button id="draw-btn">Free Draw</button>
                        <select id="color-picker">
                            <option value="black">Black</option>
                            <option value="red">Red</option>
                            <option value="blue">Blue</option>
                        </select>
                    </div>
                    <div id="canvas-container">
                        <canvas id="pdf-canvas"></canvas>
                        <canvas id="fabric-canvas"></canvas>
                    </div>
                    <div id="page-controls">
                        <button id="prev-page">&laquo; Prev</button>
                        <span id="page-num"></span> / <span id="page-count"></span>
                        <button id="next-page">Next &raquo;</button>
                    </div>
                </div>

                <button id="process-btn" disabled>Process</button>
                <div id="output-area"></div>
            </div>

            <div id="loader" class="loader">
                <div class="spinner"></div>
                <p id="loader-text">Processing...</p>
            </div>
        </div>
        <div class="modal-sidebar">
            <div class="ad-placeholder ad-sidebar">Advertisement<br>(200x400)</div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer id="contact">
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col">
                <h4>About First Love PDF</h4>
                <p>Your free, secure, and easy-to-use online PDF tool suite. All processing is done client-side for maximum privacy.</p>
            </div>
            <div class="footer-col">
                <h4>Tools</h4>
                <ul>
                    <li><a href="#all-tools">Merge PDF</a></li>
                    <li><a href="#all-tools">Split PDF</a></li>
                    <li><a href="#all-tools">Compress PDF</a></li>
                    <li><a href="#all-tools">Convert PDF</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Company</h4>
                <ul>
                    <li><a href="#about-us">About Us</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Contact</h4>
                <p>For support or inquiries, please email us at:</p>
                <a href="mailto:contact@firstlovepdf.com">contact@firstlovepdf.com</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 First Love PDF. All Rights Reserved.</p>
        </div>
    </div>
</footer>

<!-- Google Analytics (Placeholder) -->
<!--
<script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_GA_ID"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'YOUR_GA_ID');
</script>
-->

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Namespace for PDF libraries
        const { PDFDocument, rgb, degrees } = PDFLib;
        const { pptxgen } = window;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js`;

        // UI Elements
        const header = document.getElementById('header');
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        const navLinks = document.querySelectorAll('.nav-link');
        const toolsGrid = document.getElementById('tools-grid');
        const modal = document.getElementById('toolModal');
        const closeModalBtn = document.querySelector('.close-btn');
        const modalTitle = document.getElementById('modal-title');
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const toolOptions = document.getElementById('tool-options');
        const processBtn = document.getElementById('process-btn');
        const outputArea = document.getElementById('output-area');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const toolInterface = document.getElementById('tool-interface');
        const editArea = document.getElementById('edit-area');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const fabricCanvasEl = document.getElementById('fabric-canvas');
        const pageControls = {
            prev: document.getElementById('prev-page'),
            next: document.getElementById('next-page'),
            current: document.getElementById('page-num'),
            total: document.getElementById('page-count')
        };

        let currentTool = null;
        let selectedFiles = [];
        let fabricInstance = null;
        let pdfDoc = null;
        let currentPageNum = 1;
        let pageRenderQueue = [];
        let edits = {};

        // --- Tool Definitions ---
        const toolImplementations = {
            'merge-pdf': {
                title: 'Merge PDF',
                desc: 'Combine multiple PDFs into one single document.',
                icon: ' &#x2795;',
                fileType: '.pdf',
                multiple: true,
                process: async (files) => {
                    showLoader('Merging PDFs...');
                    const mergedPdf = await PDFDocument.create();
                    for (const file of files) {
                        const pdfBytes = await file.arrayBuffer();
                        const pdf = await PDFDocument.load(pdfBytes);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    createDownloadLink(mergedPdfBytes, 'merged.pdf', 'application/pdf');
                    hideLoader();
                }
            },
            'split-pdf': {
                title: 'Split PDF',
                desc: 'Extract a range of pages from a PDF file.',
                icon: ' &#x2702;',
                fileType: '.pdf',
                multiple: false,
                options: () => {
                    return `<label for="page-range">Page range (e.g., 1-3, 5, 7-9):</label>
                            <input type="text" id="page-range" placeholder="e.g., 1-3, 5, 7-9">`;
                },
                process: async (files) => {
                    showLoader('Splitting PDF...');
                    const rangeStr = document.getElementById('page-range').value;
                    if (!rangeStr) {
                        showError('Please enter a page range.');
                        hideLoader();
                        return;
                    }

                    const pdfBytes = await files.arrayBuffer();
                    const pdf = await PDFDocument.load(pdfBytes);
                    const newPdf = await PDFDocument.create();
                    
                    const pagesToExtract = [];
                    const totalPages = pdf.getPageCount();
                    
                    rangeStr.split(',').forEach(part => {
                        if (part.includes('-')) {
                            const [start, end] = part.split('-').map(Number);
                            for (let i = start; i <= end; i++) {
                                if(i > 0 && i <= totalPages) pagesToExtract.push(i - 1);
                            }
                        } else {
                            const pageNum = Number(part);
                            if(pageNum > 0 && pageNum <= totalPages) pagesToExtract.push(pageNum - 1);
                        }
                    });

                    const uniquePages = [...new Set(pagesToExtract)];
                    const copiedPages = await newPdf.copyPages(pdf, uniquePages);
                    copiedPages.forEach(page => newPdf.addPage(page));

                    const newPdfBytes = await newPdf.save();
                    createDownloadLink(newPdfBytes, 'split.pdf', 'application/pdf');
                    hideLoader();
                }
            },
            'compress-pdf': {
                title: 'Compress PDF',
                desc: 'Reduce the file size of your PDF.',
                icon: ' &#x1F5D3;',
                fileType: '.pdf',
                multiple: false,
                options: () => {
                     return `<label for="compress-quality">Compression Quality (lower is smaller):</label>
                            <input type="range" id="compress-quality" min="0.1" max="1.0" step="0.1" value="0.7">`;
                },
                 process: async (files) => {
                    // NOTE: True PDF compression is complex and often requires server-side tools
                    // This is a simplified client-side placeholder demonstrating image re-encoding.
                    showLoader('Compressing PDF (image re-encoding)...');
                    const quality = parseFloat(document.getElementById('compress-quality').value);
                    const pdfBytes = await files.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const pages = pdfDoc.getPages();
                    
                    for(const page of pages){
                        // This is a complex task. A simple approach is to re-encode images.
                        // pdf-lib does not directly support re-encoding existing images with different quality.
                        // A full implementation would require extracting images, compressing them, and replacing them.
                        // This placeholder will just re-save the PDF.
                    }
                    
                    const compressedBytes = await pdfDoc.save();
                    createDownloadLink(compressedBytes, `compressed.pdf`, 'application/pdf');
                    showError("Note: True PDF compression is complex. This feature is a placeholder and currently just re-saves the PDF.");
                    hideLoader();
                }
            },
             'pdf-to-word': {
                title: 'PDF to Word',
                desc: 'Convert your PDF to an editable Word document.',
                icon: ' &#x1F4DD;',
                fileType: '.pdf',
                multiple: false,
                process: async (files) => {
                    showLoader('Converting PDF to Text...');
                    const pdfBytes = await files.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                    }
                    createDownloadLink(new Blob([fullText], {type: 'text/plain'}), 'converted.txt', 'text/plain');
                    showError("Note: Converted to a .txt file as formatting is not preserved in client-side conversion.");
                    hideLoader();
                }
            },
            'pdf-to-ppt': {
                title: 'PDF to PowerPoint',
                desc: 'Convert each page of a PDF into a PowerPoint slide.',
                icon: ' &#x1F4C4;',
                fileType: '.pdf',
                multiple: false,
                process: async (files) => {
                    showLoader('Converting PDF to PPT...');
                    const ppt = new PptxGenJS();
                    const pdfBytes = await files.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

                    for (let i = 1; i <= pdf.numPages; i++) {
                         showLoader(`Processing page ${i}/${pdf.numPages}...`);
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const dataUrl = canvas.toDataURL('image/png');
                        
                        const slide = ppt.addSlide();
                        slide.addImage({ data: dataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                    }
                    
                    ppt.writeFile({ fileName: 'converted.pptx' });
                    hideLoader();
                }
            },
            'word-to-pdf': {
                title: 'Word to PDF',
                desc: 'Convert a DOCX file to a PDF document.',
                icon: ' &#x1F4C2;',
                fileType: '.docx',
                multiple: false,
                process: async (files) => {
                    showLoader('Converting Word to PDF...');
                    const arrayBuffer = await files.arrayBuffer();
                    const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                    const html = result.value;
                    
                    const element = document.createElement('div');
                    element.innerHTML = html;
                    document.body.appendChild(element);
                    
                    html2pdf(element, {
                        margin: 1,
                        filename: 'word.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    });
                    
                    document.body.removeChild(element);
                    hideLoader();
                }
            },
             'edit-pdf': {
                title: 'Edit PDF',
                desc: 'Add text, shapes, and drawings to your PDF.',
                icon: ' &#x270F;',
                fileType: '.pdf',
                multiple: false,
                onFileSelect: async (files) => {
                    if (files.length === 0) return;
                    showLoader('Loading PDF for editing...');
                    dropArea.style.display = 'none';
                    editArea.style.display = 'flex';
                    
                    const pdfBytes = await files.arrayBuffer();
                    pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    currentPageNum = 1;
                    edits = {};
                    await renderEditPage(currentPageNum);
                    
                    hideLoader();
                },
                process: async (files) => {
                    showLoader('Applying edits to PDF...');
                     await saveCurrentPageEdits(); // Save edits of the last viewed page
                    
                    const pdfBytes = await files.arrayBuffer();
                    const doc = await PDFDocument.load(pdfBytes);
                    const pages = doc.getPages();

                    for (const pageNumStr in edits) {
                        const pageNum = parseInt(pageNumStr);
                        const pageEdits = edits[pageNumStr];
                        const page = pages[pageNum - 1];

                        for (const edit of pageEdits) {
                            if (edit.type === 'textbox') {
                                page.drawText(edit.text, {
                                    x: edit.left,
                                    y: page.getHeight() - edit.top - (edit.height * edit.scaleY),
                                    size: edit.fontSize * edit.scaleY,
                                    color: rgb(0,0,0) // Simplification
                                });
                            } else if (edit.type === 'rect') {
                                page.drawRectangle({
                                    x: edit.left,
                                    y: page.getHeight() - edit.top - (edit.height * edit.scaleY),
                                    width: edit.width * edit.scaleX,
                                    height: edit.height * edit.scaleY,
                                    borderColor: rgb(1,0,0),
                                    borderWidth: 2
                                });
                            }
                        }
                    }
                    
                    const editedPdfBytes = await doc.save();
                    createDownloadLink(editedPdfBytes, 'edited.pdf', 'application/pdf');
                    hideLoader();
                }
            },
            'sign-pdf': {
                title: 'Sign PDF',
                desc: 'Create a signature and sign your PDF document.',
                icon: ' &#x1F58B;',
                fileType: '.pdf',
                multiple: false,
                options: () => {
                    return `<label>Draw your signature below:</label>
                            <div style="border: 1px solid #ccc; border-radius: 4px; margin-top: 5px;">
                                <canvas id="signature-canvas" width="400" height="200"></canvas>
                            </div>
                            <button type="button" id="clear-signature">Clear</button>`;
                },
                onFileSelect: () => {
                    const sigCanvas = new fabric.Canvas('signature-canvas', { isDrawingMode: true });
                    sigCanvas.freeDrawingBrush.width = 3;
                    sigCanvas.freeDrawingBrush.color = '#000000';
                    document.getElementById('clear-signature').onclick = () => sigCanvas.clear();
                },
                process: async (files) => {
                     showLoader('Adding signature...');
                    const sigCanvas = document.getElementById('signature-canvas');
                    const sigImg = sigCanvas.toDataURL('image/png');

                    const pdfBytes = await files.arrayBuffer();
                    const pdf = await PDFDocument.load(pdfBytes);
                    const pngImage = await pdf.embedPng(sigImg);
                    
                    const firstPage = pdf.getPages();
                    firstPage.drawImage(pngImage, {
                        x: 50,
                        y: firstPage.getHeight() - 150,
                        width: 150,
                        height: 75
                    });

                    const signedPdfBytes = await pdf.save();
                    createDownloadLink(signedPdfBytes, 'signed.pdf', 'application/pdf');
                    hideLoader();
                }
            },
            'watermark-pdf': {
                title: 'Watermark PDF',
                desc: 'Add a text watermark to every page of your PDF.',
                icon: ' &#x1F4A6;',
                fileType: '.pdf',
                multiple: false,
                options: () => {
                    return `<label for="watermark-text">Watermark Text:</label>
                            <input type="text" id="watermark-text" value="CONFIDENTIAL">
                            <label for="watermark-opacity">Opacity:</label>
                            <input type="range" id="watermark-opacity" min="0.1" max="1.0" step="0.1" value="0.5">`;
                },
                process: async (files) => {
                    showLoader('Adding watermark...');
                    const text = document.getElementById('watermark-text').value;
                    const opacity = parseFloat(document.getElementById('watermark-opacity').value);
                    
                    const pdfBytes = await files.arrayBuffer();
                    const pdf = await PDFDocument.load(pdfBytes);
                    const pages = pdf.getPages();
                    
                    for (const page of pages) {
                        const { width, height } = page.getSize();
                        page.drawText(text, {
                            x: width / 2 - 100,
                            y: height / 2,
                            size: 50,
                            color: rgb(0.5, 0.5, 0.5),
                            opacity: opacity,
                            rotate: degrees(45),
                        });
                    }

                    const watermarkedPdfBytes = await pdf.save();
                    createDownloadLink(watermarkedPdfBytes, 'watermarked.pdf', 'application/pdf');
                    hideLoader();
                }
            },
            'rotate-pdf': {
                title: 'Rotate PDF',
                desc: 'Rotate all pages in a PDF document.',
                icon: ' &#x21BB;',
                fileType: '.pdf',
                multiple: false,
                options: () => {
                    return `<label for="rotation-angle">Rotation Angle:</label>
                            <select id="rotation-angle">
                                <option value="90">90° Clockwise</option>
                                <option value="180">180°</option>
                                <option value="270">270° Clockwise</option>
                            </select>`;
                },
                process: async (files) => {
                    showLoader('Rotating PDF...');
                    const angle = parseInt(document.getElementById('rotation-angle').value);

                    const pdfBytes = await files.arrayBuffer();
                    const pdf = await PDFDocument.load(pdfBytes);
                    
                    pdf.getPages().forEach(page => {
                        const currentRotation = page.getRotation().angle;
                        page.setRotation(degrees(currentRotation + angle));
                    });

                    const rotatedPdfBytes = await pdf.save();
                    createDownloadLink(rotatedPdfBytes, 'rotated.pdf', 'application/pdf');
                    hideLoader();
                }
            },
            // --- Placeholder tools ---
            'placeholder-1': { title: 'PDF to JPG', desc: 'Convert each PDF page to a JPG image.', icon: '&#128444;' },
            'placeholder-2': { title: 'JPG to PDF', desc: 'Convert JPG images to a PDF file.', icon: '&#128247;' },
            'placeholder-3': { title: 'PDF to Excel', desc: 'Convert PDF tables to Excel spreadsheets.', icon: '&#128196;' },
            'placeholder-4': { title: 'Excel to PDF', desc: 'Convert Excel spreadsheets to PDF.', icon: '&#128196;' },
            'placeholder-5': { title: 'PowerPoint to PDF', desc: 'Convert PPTX presentations to PDF.', icon: '&#128196;' },
            'placeholder-6': { title: 'Unlock PDF', desc: 'Remove password and restrictions from a PDF.', icon: '&#128275;' },
            'placeholder-7': { title: 'Protect PDF', desc: 'Add a password and secure your PDF.', icon: '&#128274;' },
            'placeholder-8': { title: 'Page Numbers', desc: 'Add page numbers to your PDF file.', icon: '&#35;&#65039;&#8419;' },
            'placeholder-9': { title: 'PDF to PDF/A', desc: 'Convert PDF to PDF/A for long-term archiving.', icon: '&#128193;' },
            'placeholder-10': { title: 'Organize PDF', desc: 'Sort, add, and remove pages from a PDF.', icon: '&#128210;' },
            'placeholder-11': { title: 'Repair PDF', desc: 'Attempt to repair a corrupted or damaged PDF.', icon: '&#128736;' },
            'placeholder-12': { title: 'OCR PDF', desc: 'Make scanned PDFs searchable and selectable.', icon: '&#128269;', isNew: true },
            'placeholder-13': { title: 'HTML to PDF', desc: 'Convert web pages to PDF documents.', icon: '&#128279;' },
            'placeholder-14': { title: 'PNG to PDF', desc: 'Convert PNG images to PDF.', icon: '&#128248;' },
            'placeholder-15': { title: 'TIFF to PDF', desc: 'Convert TIFF images to PDF.', icon: '&#128443;' },
            'placeholder-16': { title: 'BMP to PDF', desc: 'Convert BMP images to PDF.', icon: '&#128442;' },
            'placeholder-17': { title: 'RTF to PDF', desc: 'Convert Rich Text Format files to PDF.', icon: '&#128195;' },
        };
        
        // --- UI Interaction Logic ---
        
        // Header scroll effect
        window.addEventListener('scroll', () => {
            header.classList.toggle('scrolled', window.scrollY > 50);
        });
        
        // Hamburger menu
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });
        navLinks.forEach(link => link.addEventListener('click', () => {
             hamburger.classList.remove('active');
            navMenu.classList.remove('active');
        }));
        
        // Intersection Observer for animations
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        
        // Dynamic Tool Card Generation
        function generateToolCards() {
            Object.keys(toolImplementations).forEach(key => {
                const tool = toolImplementations[key];
                if (!tool.process) { // Mark as placeholder
                    tool.process = async () => {
                         showError(`The "${tool.title}" tool is not yet implemented. Please check back later.`);
                         hideLoader();
                    }
                }

                const card = document.createElement('div');
                card.className = 'tool-card reveal';
                card.dataset.tool = key;
                card.innerHTML = `
                    ${tool.isNew ? '<div class="badge">New!</div>' : ''}
                    <div class="tool-icon">${tool.icon || '&#128196;'}</div>
                    <h3>${tool.title}</h3>
                    <p>${tool.desc}</p>
                `;
                card.addEventListener('click', () => openModal(key));
                toolsGrid.appendChild(card);
                observer.observe(card);
            });
        }

        // Modal Logic
        function openModal(toolKey) {
            currentTool = toolImplementations[toolKey];
            resetModal();
            modalTitle.textContent = currentTool.title;
            fileInput.accept = currentTool.fileType || '*/*';
            fileInput.multiple = currentTool.multiple || false;
            
            if (currentTool.options) {
                toolOptions.innerHTML = currentTool.options();
            }

            if (currentTool.onFileSelect) {
                 // Initial call for UI setup like signature canvas
                currentTool.onFileSelect(selectedFiles);
            }

            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
            currentTool = null;
        }

        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        
        function resetModal() {
            selectedFiles = [];
            updateFileList();
            toolOptions.innerHTML = '';
            outputArea.innerHTML = '';
            processBtn.disabled = true;
            dropArea.style.display = 'block';
            editArea.style.display = 'none';
            if(fabricInstance) {
                fabricInstance.dispose();
                fabricInstance = null;
            }
            pdfDoc = null;
            edits = {};
            currentPageNum = 1;
        }

        // File Handling
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => {
                return currentTool.fileType ? file.name.toLowerCase().endsWith(currentTool.fileType) : true;
            });

            if (newFiles.length === 0) {
                 showError(`Please select a valid file type (${currentTool.fileType})`);
                return;
            }

            if (currentTool.multiple) {
                selectedFiles.push(...newFiles);
            } else {
                selectedFiles = [newFiles];
            }
            
            updateFileList();
            processBtn.disabled = false;
            
            if (currentTool.onFileSelect) {
                currentTool.onFileSelect(selectedFiles);
            }
        }
        
        function updateFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `<span>${file.name}</span>
                                  <button class="remove-file-btn" data-index="${index}">X</button>`;
                fileList.appendChild(item);
            });
            
            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    if (selectedFiles.length === 0) {
                        processBtn.disabled = true;
                    }
                });
            });
        }

        // Processing Logic
        processBtn.addEventListener('click', async () => {
            toolInterface.style.display = 'none';
            loader.style.display = 'block';
            outputArea.innerHTML = '';
            try {
                await currentTool.process(selectedFiles);
            } catch (error) {
                console.error('Processing error:', error);
                showError(`An error occurred: ${error.message}`);
                hideLoader();
            }
        });

        // Edit PDF Logic
        async function renderEditPage(num) {
            if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;
            
            await saveCurrentPageEdits();

            currentPageNum = num;
            pageControls.current.textContent = num;
            pageControls.total.textContent = pdfDoc.numPages;

            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });
            
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;
            fabricCanvasEl.height = viewport.height;
            fabricCanvasEl.width = viewport.width;
            
            const renderContext = {
                canvasContext: pdfCanvas.getContext('2d'),
                viewport: viewport
            };
            await page.render(renderContext).promise;

            if(fabricInstance) fabricInstance.dispose();
            fabricInstance = new fabric.Canvas(fabricCanvasEl, {
                isDrawingMode: false
            });

            // Load existing edits for this page
            if(edits[num]) {
                fabricInstance.loadFromJSON(edits[num], fabricInstance.renderAll.bind(fabricInstance));
            }
        }

        async function saveCurrentPageEdits() {
            if (fabricInstance) {
                edits[currentPageNum] = fabricInstance.toJSON();
            }
        }

        pageControls.prev.addEventListener('click', () => {
            if (currentPageNum > 1) renderEditPage(currentPageNum - 1);
        });
        pageControls.next.addEventListener('click', () => {
            if (currentPageNum < pdfDoc.numPages) renderEditPage(currentPageNum + 1);
        });
        
        document.getElementById('add-text-btn').addEventListener('click', () => {
            if(!fabricInstance) return;
            fabricInstance.isDrawingMode = false;
            const text = new fabric.Textbox('Hello world', {
                left: 50,
                top: 50,
                width: 150,
                fontSize: 20
            });
            fabricInstance.add(text);
        });
        document.getElementById('add-rect-btn').addEventListener('click', () => {
            if(!fabricInstance) return;
            fabricInstance.isDrawingMode = false;
            const rect = new fabric.Rect({
                left: 100,
                top: 100,
                fill: 'transparent',
                stroke: 'red',
                strokeWidth: 2,
                width: 60,
                height: 70
            });
            fabricInstance.add(rect);
        });
         document.getElementById('draw-btn').addEventListener('click', () => {
            if(!fabricInstance) return;
            fabricInstance.isDrawingMode = !fabricInstance.isDrawingMode;
        });
        document.getElementById('color-picker').addEventListener('change', (e) => {
             if(!fabricInstance) return;
             fabricInstance.freeDrawingBrush.color = e.target.value;
        });

        // Utility Functions
        function showLoader(text) {
            loaderText.textContent = text || 'Processing...';
            toolInterface.style.display = 'none';
            loader.style.display = 'block';
        }

        function hideLoader() {
            loader.style.display = 'none';
            toolInterface.style.display = 'block';
        }

        function showError(message) {
            alert(message);
        }

        function createDownloadLink(data, filename, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.className = 'download-link';
            a.textContent = `Download ${filename}`;
            outputArea.innerHTML = '';
            outputArea.appendChild(a);
        }

        // --- Initialization ---
        generateToolCards();
    });
</script>
